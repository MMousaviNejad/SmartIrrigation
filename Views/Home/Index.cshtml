@{
    ViewData["Title"] = "Home Page";
}

<div class="d-flex flex-column text-center">
    <div id="chartContainer" style="height: 370px; width: 100%;"></div>

    <div class="mt-3">
        Pump Status: <span id="pumpstatus" class="text-bg-danger p-2 rounded-circle">off</span>
        <button onclick="setPumpStatus(event)" id="pumpbutton" class="ms-4 btn btn-success">on</button>
    </div>
</div>
<script>
    window.onload = function () {

    var dataPoints = [];

    var chart = new CanvasJS.Chart("chartContainer", {
        animationEnabled: true,
        theme: "light2",
        title: {
            text: "Moisture History"
        },
        axisY: {
            title: "Moisture",
            titleFontSize: 24
        },
        data: [{
            type: "line",
            yValueFormatString: "###",
            dataPoints: dataPoints
        }]
    });

    function addData(data) {
        for (var i = 0; i < data.length; i++) {
            dataPoints.push({
                x: data[i].x,
                y: data[i].y
            });
        }
        chart.render();

    }

    function soilHandle(data) {
        $("#pumpstatus").text(data.pump_status);
        if (data.pump_status == "on"){
            $("#pumpstatus").removeClass("text-bg-danger").addClass("text-bg-success");
        }else{;
            $("#pumpstatus").removeClass("text-bg-success").addClass("text-bg-danger");
        }
    }

        $.getJSON("/Home/JSON", addData);

    setInterval(()=>{
        $.getJSON("/Home/JSON", addData);

    },5000);

    setInterval(()=>{
        $.getJSON("/Soil/soil-status", soilHandle);

    },1000);
    }
function setPumpStatus(e){
        if ($(e.target).text()=="on"){
            fetch("/Soil/pump-status",{
                method: "post",
                headers:{
                    "Content-Type" : "application/json"
                },
                    body: JSON.stringify({
                    "PumpStatus": "on"
                })
            }).then(res => {
                if (res.ok){
                    $(e.target).text("off");
                    $(e.target).removeClass("btn-success").addClass("btn-danger");
                }
            });

        }else{
            fetch("/Soil/pump-status",{
                method: "post",
                headers:{
                    "Content-Type" : "application/json"
                },
                    body: JSON.stringify({
                    "PumpStatus": "off"
                })
            }).then(res => {
                if (res.ok){
                    $(e.target).text("on");
                    $(e.target).removeClass("btn-danger").addClass("btn-success");
                }
            });

        }
    }
</script>